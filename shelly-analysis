<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shelly Plus Uni - Voltage Analysis</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { 
            LineChart, Line, XAxis, YAxis, CartesianGrid, 
            Tooltip, Legend, ResponsiveContainer 
        } = Recharts;

        const VoltageAnalysis = () => {
            const [data, setData] = useState(null);
            const [stats, setStats] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [filterMode, setFilterMode] = useState('time');
            const [rawCSV, setRawCSV] = useState(null);
            const [driftAnalysis, setDriftAnalysis] = useState(null);
            const [showTrendLine, setShowTrendLine] = useState(false);

            // --- Logic Functions (Ported from your original code) ---
            const calculateStats = (values) => {
                const n = values.length || 1;
                const mean = values.reduce((a, b) => a + b, 0) / n;
                const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / n;
                const std = Math.sqrt(variance);
                const min = Math.min(...values);
                const max = Math.max(...values);
                return {
                    mean: mean.toFixed(4),
                    std: (std * 1000).toFixed(2),
                    min: min.toFixed(3),
                    max: max.toFixed(3),
                    range: ((max - min) * 1000).toFixed(1),
                };
            };

            const calculateDriftAnalysis = (filteredData) => {
                if (filteredData.length < 2) return null;
                const startTime = filteredData[0].timestamp.getTime();
                const points = filteredData.map((d) => ({
                    x: (d.timestamp.getTime() - startTime) / (1000 * 60 * 60 * 24),
                    y: d.ma60,
                }));

                const n = points.length;
                const sumX = points.reduce((sum, p) => sum + p.x, 0);
                const sumY = points.reduce((sum, p) => sum + p.y, 0);
                const sumXY = points.reduce((sum, p) => sum + p.x * p.y, 0);
                const sumX2 = points.reduce((sum, p) => sum + p.x * p.x, 0);
                const denom = n * sumX2 - sumX * sumX;
                if (denom === 0) return null;

                const slope = (n * sumXY - sumX * sumY) / denom;
                const intercept = (sumY - slope * sumX) / n;
                const ssTotal = points.reduce((sum, p) => sum + Math.pow(p.y - (sumY / n), 2), 0);
                const ssResidual = points.reduce((sum, p) => sum + Math.pow(p.y - (slope * p.x + intercept), 2), 0);
                const r2 = ssTotal === 0 ? 1 : 1 - ssResidual / ssTotal;
                const slopeStdError = Math.sqrt(ssResidual / (n - 2) / (sumX2 - (sumX * sumX) / n));

                return {
                    slope, slopeMvPerDay: slope * 1000, intercept, r2,
                    confidenceInterval95: slopeStdError * 1.96 * 1000,
                    timeSpanDays: points[points.length - 1].x,
                    totalDriftMv: slope * points[points.length - 1].x * 1000,
                    startVoltage: filteredData[0].ma60,
                    endVoltage: filteredData[filteredData.length - 1].ma60,
                    startDate: filteredData[0].timestamp,
                    endDate: filteredData[filteredData.length - 1].timestamp,
                };
            };

            const processCSV = (csvText, mode = 'time') => {
                try {
                    const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
                    const processedData = parsed.data
                        .filter(row => row.last_changed && row.state)
                        .map(row => ({
                            timestamp: new Date(row.last_changed),
                            voltage: parseFloat(row.state)
                        }))
                        .filter(d => !isNaN(d.voltage) && d.voltage > 0 && !isNaN(d.timestamp.getTime()))
                        .sort((a, b) => a.timestamp - b.timestamp);

                    if (processedData.length === 0) throw new Error('No valid data');

                    // Calculate MA60
                    let filtered = [];
                    if (mode === 'time') {
                        let startIdx = 0; let sum = 0;
                        for (let i = 0; i < processedData.length; i++) {
                            sum += processedData[i].voltage;
                            while (startIdx < i && (processedData[i].timestamp - processedData[startIdx].timestamp) / 1000 > 60) {
                                sum -= processedData[startIdx].voltage;
                                startIdx++;
                            }
                            filtered.push({ ...processedData[i], ma60: sum / (i - startIdx + 1) });
                        }
                    } else {
                        filtered = processedData.map((p, idx) => {
                            if (idx < 59) return { ...p, ma60: null };
                            const win = processedData.slice(idx - 59, idx + 1);
                            return { ...p, ma60: win.reduce((a, b) => a + b.voltage, 0) / 60 };
                        });
                    }

                    const rawStats = calculateStats(processedData.map(d => d.voltage));
                    const ma60Values = filtered.filter(d => d.ma60 !== null).map(d => d.ma60);
                    const ma60Stats = calculateStats(ma60Values);
                    const drift = calculateDriftAnalysis(filtered.filter(d => d.ma60 !== null));
                    
                    // Downsample for performance (~1000 points)
                    const stride = Math.max(1, Math.floor(filtered.length / 1000));
                    const chartData = filtered.filter((_, i) => i % stride === 0).map(d => ({
                        time: d.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                        raw: d.voltage,
                        ma60: d.ma60,
                        trend: drift ? (drift.slope * ((d.timestamp - filtered[0].timestamp)/(1000*60*60*24)) + drift.intercept) : null
                    }));

                    setStats({ raw: rawStats, ma60: ma60Stats, sampleCount: processedData.length, mode });
                    setDriftAnalysis(drift);
                    setData(chartData);
                    setLoading(false);
                } catch (err) {
                    setError(err.message);
                    setLoading(false);
                }
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setLoading(true);
                const reader = new FileReader();
                reader.onload = (event) => {
                    setRawCSV(event.target.result);
                    processCSV(event.target.result, filterMode);
                };
                reader.readAsText(file);
            };

            if (!data && !loading) {
                return (
                    <div className="flex items-center justify-center h-screen text-center">
                        <div className="p-10 bg-gray-800 rounded-xl shadow-2xl border border-gray-700">
                            <h1 className="text-3xl font-bold mb-4">Shelly Voltage Analyst</h1>
                            <p className="text-gray-400 mb-6">Drop your Home Assistant history.csv here</p>
                            <input type="file" onChange={handleFileUpload} className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer" />
                        </div>
                    </div>
                );
            }

            return (
                <div className="p-6 max-w-6xl mx-auto">
                    <header className="flex justify-between items-center mb-8 border-b border-gray-800 pb-4">
                        <h1 className="text-2xl font-bold text-blue-400">Shelly Plus Uni Analysis</h1>
                        <button onClick={() => location.reload()} className="bg-gray-700 px-4 py-2 rounded text-sm hover:bg-gray-600">Load New File</button>
                    </header>

                    {stats && (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div className="bg-gray-800 p-4 rounded-lg">
                                <div className="text-gray-400 text-xs uppercase">Noise Reduction</div>
                                <div className="text-2xl font-mono text-green-400">
                                    {(100 * (1 - parseFloat(stats.ma60.std) / parseFloat(stats.raw.std))).toFixed(1)}%
                                </div>
                            </div>
                            <div className="bg-gray-800 p-4 rounded-lg">
                                <div className="text-gray-400 text-xs uppercase">Drift Rate</div>
                                <div className={`text-2xl font-mono ${driftAnalysis?.slopeMvPerDay < 0 ? 'text-red-400' : 'text-green-400'}`}>
                                    {driftAnalysis?.slopeMvPerDay.toFixed(3)} mV/day
                                </div>
                            </div>
                            <div className="bg-gray-800 p-4 rounded-lg">
                                <div className="text-gray-400 text-xs uppercase">RÂ² Fit Quality</div>
                                <div className="text-2xl font-mono text-purple-400">{driftAnalysis?.r2.toFixed(4)}</div>
                            </div>
                        </div>
                    )}

                    <div className="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                        <h2 className="mb-4 text-lg font-semibold flex justify-between">
                            Voltage Comparison
                            <label className="text-xs font-normal flex items-center gap-2 text-gray-400">
                                <input type="checkbox" checked={showTrendLine} onChange={e => setShowTrendLine(e.target.checked)} />
                                Show Linear Trend
                            </label>
                        </h2>
                        <div className="h-[400px] w-full">
                            <ResponsiveContainer>
                                <LineChart data={data}>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                                    <XAxis dataKey="time" stroke="#9CA3AF" tick={{fontSize: 10}} />
                                    <YAxis domain={['dataMin - 0.002', 'dataMax + 0.002']} stroke="#9CA3AF" tickFormatter={v => v.toFixed(3)} />
                                    <Tooltip contentStyle={{backgroundColor: '#1f2937', border: 'none'}} />
                                    <Legend />
                                    <Line type="monotone" dataKey="raw" stroke="#f59e0b" dot={false} strokeWidth={1} opacity={0.4} name="Raw Voltage" />
                                    <Line type="monotone" dataKey="ma60" stroke="#10b981" dot={false} strokeWidth={2} name="MA-60 Filtered" />
                                    {showTrendLine && <Line type="monotone" dataKey="trend" stroke="#a78bfa" dot={false} strokeDasharray="5 5" name="Linear Drift" />}
                                </LineChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<VoltageAnalysis />);
    </script>
</body>
</html>
